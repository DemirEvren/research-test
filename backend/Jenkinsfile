pipeline {
    agent any

    environment {
        DOCKER_IMAGE = 'backend-app'  // Final production image
        TEST_IMAGE = 'backend-test'  // Temporary test image
        DB_CONTAINER = 'mysql-test-db'  // Database for testing
        DB_NAME = 'testdb'
        DB_USER = 'root'
        DB_PASS = 'password'
        AWS_HOST = 'your-ec2-instance'  // Replace with your AWS instance
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/DemirEvren/research-test.git'
            }
        }
        
    stage('Cleanup Old Containers') {
        steps {
            sh 'docker stop test-mysql || true'
            sh 'docker rm test-mysql || true'
            sh 'docker stop test-backend || true' 
            sh 'docker rm test-backend || true' 
            
            }
        }

        stage('Build Test Image') {
            steps {
                dir('backend') {
                    sh 'docker build -t ${TEST_IMAGE} .'
                }
            }
        }

stage('Run Tests in Docker') {
    steps {
        script {
            sh '''
            echo "üöÄ Starting test containers..."
            docker-compose -f backend/compose-jenkins.test.yml up -d

            echo "‚è≥ Waiting for backend to start..."
            sleep 15

            echo "üöÄ Running tests..."
            docker exec test-backend /bin/sh -c '
                npx jest --version
                export TEST_MODE=true
                echo "üîç TEST_MODE is set to: $TEST_MODE"
                npm test -- --verbose || echo "‚ùå Tests failed"
            '

            '''
        }
    }
}


        stage('Build Production Image') {
            steps {
                dir('backend') {
                    sh 'docker build -t ${DOCKER_IMAGE} .'
                }
            }
        }

        // stage('Deploy to AWS') {
        //     steps {
        //         sshagent(['ec2-ssh-key']) {
        //             sh '''
        //             docker save ${DOCKER_IMAGE} | ssh ec2-user@${AWS_HOST} 'docker load'
        //             ssh ec2-user@${AWS_HOST} 'docker run -d -p 8090:8090 --name backend ${DOCKER_IMAGE}'
        //             '''
        //         }
        //     }
        // }
    }

   post {
    always {
        sh 'docker system prune -af'  // ‚úÖ Remove unused Docker resources
        cleanWs()  // ‚úÖ Clean Jenkins workspace
        }
    }

}
